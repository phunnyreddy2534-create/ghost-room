<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Ghost Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="room-header">
  <div class="logo">ðŸ‘» Ghost Room</div>
  <div>
    <button id="exitBtn">Exit</button>
    <button id="shareBtn">Share</button>
  </div>
</header>

<div class="room-id" id="roomId"></div>

<div class="messages" id="messages"></div>

<div class="input-bar">
  <input id="msgInput" placeholder="Type a message..." autocomplete="off" />
  <button id="sendBtn">Send</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  /* ===== SUPABASE ===== */
  const supabase = window.supabase.createClient(
    "https://ehvusinvfwsaxguuebfc.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVodnVzaW52ZndzYXhndXVlYmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNTcyMzYsImV4cCI6MjA4MjkzMzIzNn0.6W8OrbTz6RhN3P3R0KIN80Ec9GlkoMF4F0-Q4xRyy48"
  );

  const room = new URLSearchParams(location.search).get("room");
  if (!room) location.href = "/";

  /* ======================================================
     ðŸ”’ NEW: ROOM EXPIRY VALIDATION (SAFE ADDITION)
     ====================================================== */
  const { data: roomData, error: roomError } = await supabase
    .from("rooms")
    .select("expires_at, expired")
    .eq("room_code", room)
    .single();

  // If room not found OR explicitly expired
  if (!roomData || roomData.expired === true) {
    alert("This room has expired.");
    location.href = "/";
    return;
  }

  // If expires_at exists, enforce time expiry
  if (roomData.expires_at) {
    const now = new Date();
    const expiresAt = new Date(roomData.expires_at);
    if (now > expiresAt) {
      alert("This room has expired.");
      location.href = "/";
      return;
    }
  }
  /* ===== END EXPIRY VALIDATION ===== */

  const roomIdEl = document.getElementById("roomId");
  const messagesBox = document.getElementById("messages");
  const input = document.getElementById("msgInput");

  roomIdEl.textContent = "Room ID: " + room;

  /* ===== CLIENT ID ===== */
  let clientId = sessionStorage.getItem("ghost_client_id");
  if (!clientId) {
    clientId = crypto.randomUUID();
    sessionStorage.setItem("ghost_client_id", clientId);
  }

  /* ===== LOCAL CACHE KEY ===== */
  const cacheKey = `ghost_messages_${room}`;

  function getCachedMessages() {
    try {
      return JSON.parse(localStorage.getItem(cacheKey)) || [];
    } catch {
      return [];
    }
  }

  function saveCachedMessage(msg) {
    const cache = getCachedMessages();
    cache.push(msg);
    localStorage.setItem(cacheKey, JSON.stringify(cache));
  }

  /* ===== MESSAGE UI ===== */
  function addMessage(text, sender, time) {
    const div = document.createElement("div");
    div.className = "msg " + (sender === clientId ? "you" : "other");
    div.innerHTML = `<div>${text}</div><div class="time">${time}</div>`;
    messagesBox.appendChild(div);
    messagesBox.scrollTop = messagesBox.scrollHeight;
  }

  /* ===== LOAD FROM CACHE FIRST ===== */
  const cached = getCachedMessages();
  cached.forEach(m => addMessage(m.text, m.sender, m.time));

  /* ===== LOAD FROM DATABASE ===== */
  const { data: history } = await supabase
    .from("messages")
    .select("*")
    .eq("room_code", room)
    .order("created_at", { ascending: true });

  history?.forEach(m => {
    addMessage(
      m.content,
      m.client_id,
      new Date(m.created_at).toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      })
    );
  });

  /* ===== CHANNEL ===== */
  const roomChannel = supabase.channel(`room-${room}`);

  /* ===== SEND ===== */
  document.getElementById("sendBtn").onclick = async () => {
    const text = input.value.trim();
    if (!text) return;
    input.value = "";

    const time = new Date().toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit"
    });

    addMessage(text, clientId, time);
    saveCachedMessage({ text, sender: clientId, time });

    await supabase.from("messages").insert({
      room_code: room,
      client_id: clientId,
      content: text
    });
  };

  /* ===== REALTIME ===== */
  roomChannel.on(
    "postgres_changes",
    { event: "INSERT", schema: "public", table: "messages", filter: `room_code=eq.${room}` },
    payload => {
      if (payload.new.client_id === clientId) return;
      const time = new Date(payload.new.created_at).toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      });
      addMessage(payload.new.content, payload.new.client_id, time);
      saveCachedMessage({
        text: payload.new.content,
        sender: payload.new.client_id,
        time
      });
    }
  );

  await roomChannel.subscribe();

  /* ===== EXIT ===== */
  document.getElementById("exitBtn").onclick = () => {
    if (confirm(
      "Leave Ghost Room?\n\n" +
      "â€¢ Messages auto-delete after expiry\n" +
      "â€¢ Room expires automatically\n\n" +
      "Thank you for using Ghost Room ðŸ‘»"
    )) {
      location.href = "/";
    }
  };

  document.getElementById("shareBtn").onclick = async () => {
    if (navigator.share) {
      navigator.share({ title: "Ghost Room", url: location.href });
    } else {
      await navigator.clipboard.writeText(location.href);
    }
  };

});
</script>

</body>
</html>
