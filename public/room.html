<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IRA Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
/* === SAME CSS ‚Äî UNCHANGED === */
body{margin:0;height:100vh;display:flex;flex-direction:column;font-family:Inter,system-ui;background:radial-gradient(circle at top,#141633,#050507 70%);color:#fff;transition:background 1.2s ease;}
body.fading{background:radial-gradient(circle at top,#0e1028,#030307 75%);}
.room-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:rgba(10,11,20,.75);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06);}
.header-left{display:flex;align-items:center;gap:12px;}
.ira-logo{width:34px;height:34px;filter:drop-shadow(0 0 16px rgba(111,124,255,.45));}
.ira-ring{animation:breath 6s ease-in-out infinite;}
.ira-wave{animation:wave 4.5s ease-in-out infinite;}
@keyframes breath{0%,100%{opacity:.85;stroke-width:3.5}50%{opacity:1;stroke-width:4.5}}
@keyframes wave{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}
.logo-text{font-weight:600;}
.menu-btn{font-size:22px;background:none;border:none;color:white;cursor:pointer;}
.messages{flex:1;padding:18px 14px;overflow-y:auto;display:flex;flex-direction:column;}
.system{text-align:center;color:rgba(255,255,255,.55);font-size:13px;margin:22px 0 8px;}
.presence{text-align:center;font-size:12px;color:rgba(255,255,255,.35);margin-bottom:18px;}
.msg{max-width:78%;padding:12px 16px;margin-bottom:12px;font-size:14px;line-height:1.45;animation:pop .18s ease-out;}
.msg.you{align-self:flex-end;background:linear-gradient(135deg,#6F7CFF,#8E97FF);border-radius:18px 18px 6px 18px;}
.msg.other{align-self:flex-start;background:#23233b;border-radius:18px 18px 18px 6px;}
@keyframes pop{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:none}}
.input-bar{display:flex;gap:10px;padding:12px;background:rgba(10,11,20,.85);border-top:1px solid rgba(255,255,255,.06);}
.input-bar input{flex:1;padding:12px 16px;border-radius:20px;border:none;background:#141633;color:white;}
.send{padding:12px 18px;border:none;border-radius:18px;background:linear-gradient(135deg,#6F7CFF,#8E97FF);color:white;font-weight:600;cursor:pointer;}
.menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:1000;}
.menu{position:absolute;top:64px;right:12px;width:220px;background:rgba(20,22,45,.78);border-radius:18px;padding:10px;}
.menu-item{padding:14px;border-radius:14px;margin-bottom:8px;background:#23233b;display:flex;justify-content:space-between;}
.menu-item.danger{background:#3a1f28;}
#exitOverlay{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;flex-direction:column;z-index:2000;}
</style>
</head>

<body>

<header class="room-header">
  <div class="header-left">
    <svg class="ira-logo" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="42" fill="none" stroke="#6F7CFF" stroke-width="4"/>
      <path d="M20 52 C30 46 40 46 50 52 C60 58 70 58 80 52" fill="none" stroke="#6F7CFF" stroke-width="3" stroke-linecap="round"/>
    </svg>
    <span class="logo-text">IRA</span>
  </div>
  <button id="menuBtn" class="menu-btn">‚ò∞</button>
</header>

<div class="messages" id="messages">
  <div class="system">You are anonymous here. Silence is allowed.</div>
  <div class="presence">quiet presence ¬∑¬∑¬∑</div>
</div>

<div class="input-bar">
  <input id="msgInput" placeholder="Type without being known‚Ä¶">
  <button class="send" id="sendBtn">Send</button>
</div>

<div id="menuOverlay" class="menu-overlay">
  <div class="menu">
    <div class="menu-item">üí§ Inactivity</div>
    <div class="menu-item" id="shareBtn">üîó Share quietly</div>
    <div class="menu-item danger" id="exitBtn">üóëÔ∏è Leave</div>
  </div>
</div>

<div id="exitOverlay">
  <div>Messages fading‚Ä¶</div>
  <div style="font-size:64px">üóëÔ∏è</div>
</div>

<script>
/* ‚úÖ CORRECT SUPABASE CLIENT */
const supabase = window.supabase.createClient(
  IRA_CONFIG.SUPABASE_URL,
  IRA_CONFIG.SUPABASE_ANON_KEY
);

const roomCode = new URLSearchParams(location.search).get("room") || "default";
const messagesEl = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const menuBtn = document.getElementById("menuBtn");
const menuOverlay = document.getElementById("menuOverlay");
const exitBtn = document.getElementById("exitBtn");
const shareBtn = document.getElementById("shareBtn");

/* MENU */
menuBtn.onclick = () => menuOverlay.style.display = "block";
menuOverlay.onclick = e => { if(e.target === menuOverlay) menuOverlay.style.display="none"; };

/* LOAD */
async function loadMessages(){
  const { data } = await supabase
    .from("messages")
    .select("*")
    .eq("room_code", roomCode)
    .order("created_at");
  data?.forEach(renderMessage);
}

/* REALTIME */
supabase.channel("room-"+roomCode)
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`room_code=eq.${roomCode}`},
    payload => renderMessage(payload.new))
  .subscribe();

/* SEND */
sendBtn.onclick = async ()=>{
  const text = msgInput.value.trim();
  if(!text) return;
  await supabase.from("messages").insert({ room_code:roomCode, content:text });
  msgInput.value="";
};

/* RENDER */
function renderMessage(m){
  const d=document.createElement("div");
  d.className="msg other";
  d.textContent=m.content;
  messagesEl.appendChild(d);
  messagesEl.scrollTop=messagesEl.scrollHeight;
}

/* SHARE */
shareBtn.onclick=()=>navigator.clipboard.writeText(location.href);

/* EXIT */
exitBtn.onclick=()=>location.href="/";

loadMessages();
</script>

</body>
</html>
