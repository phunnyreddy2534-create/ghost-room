<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IRA Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="style.css">

<!-- Supabase + Config -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
</head>

<body>

<header class="room-header">
  <div class="header-left">
    <!-- Unified IRA logo (same concept everywhere) -->
    <svg class="ira-logo" viewBox="0 0 100 100" aria-hidden="true">
      <defs>
        <linearGradient id="iraGlow" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#6F7CFF"/>
          <stop offset="100%" stop-color="#8E97FF"/>
        </linearGradient>
      </defs>
      <circle cx="50" cy="50" r="42" fill="none" stroke="url(#iraGlow)" stroke-width="4" class="ira-ring"/>
      <path d="M20 52 C30 46 40 46 50 52 C60 58 70 58 80 52"
        fill="none" stroke="url(#iraGlow)" stroke-width="3" stroke-linecap="round" class="ira-wave"/>
    </svg>
    <span class="logo-text">IRA</span>
  </div>

  <button id="menuBtn" class="menu-btn" aria-label="Room menu">â˜°</button>
</header>

<main class="messages" id="messages">
  <div class="system">You are anonymous here. Silence is allowed.</div>
  <div class="system" id="emptyHint">This room is quiet. You can speak.</div>
</main>

<footer class="input-bar" id="inputBar">
  <input id="msgInput" placeholder="Type without being knownâ€¦" autocomplete="off">
  <button id="sendBtn" class="primary-btn">Send</button>
</footer>

<!-- MENU -->
<div id="menuOverlay" class="menu-overlay" aria-hidden="true">
  <div class="menu">
    <div class="menu-item" id="shareBtn">ğŸ”— Share quietly</div>
    <div class="menu-item danger" id="exitBtn">ğŸ—‘ï¸ Leave room</div>
  </div>
</div>

<!-- EXIT OVERLAY -->
<div id="exitOverlay" style="
  position:fixed;inset:0;display:none;
  background:rgba(0,0,0,.9);
  align-items:center;justify-content:center;
  flex-direction:column;z-index:2000">
  <div style="opacity:.7">Messages fadingâ€¦</div>
  <div style="font-size:64px;margin-top:18px">ğŸ—‘ï¸</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ---------- STATE ---------- */
  const roomCode = new URLSearchParams(location.search).get("room");
  let exiting = false;

  /* ---------- SUPABASE ---------- */
  const supabase = window.supabase.createClient(
    IRA_CONFIG.SUPABASE_URL,
    IRA_CONFIG.SUPABASE_ANON_KEY
  );

  /* ---------- DOM ---------- */
  const messagesEl = document.getElementById("messages");
  const emptyHint = document.getElementById("emptyHint");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");

  const menuBtn = document.getElementById("menuBtn");
  const menuOverlay = document.getElementById("menuOverlay");
  const shareBtn = document.getElementById("shareBtn");
  const exitBtn = document.getElementById("exitBtn");
  const exitOverlay = document.getElementById("exitOverlay");

  /* ---------- MENU ---------- */
  menuBtn.onclick = () => {
    menuOverlay.style.display = "block";
    menuOverlay.setAttribute("aria-hidden","false");
  };

  menuOverlay.onclick = (e) => {
    if (e.target === menuOverlay) closeMenu();
  };

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeMenu();
  });

  function closeMenu(){
    menuOverlay.style.display = "none";
    menuOverlay.setAttribute("aria-hidden","true");
  }

  /* ---------- SHARE (always works) ---------- */
  shareBtn.onclick = async () => {
    closeMenu();
    try{
      if (navigator.share){
        await navigator.share({
          title: "IRA Room",
          url: location.href
        });
      } else {
        await navigator.clipboard.writeText(location.href);
        toast("Room link copied");
      }
    } catch(e){}
  };

  /* ---------- SEND MESSAGE ---------- */
  sendBtn.onclick = async () => {
    const text = msgInput.value.trim();
    if (!text || exiting) return;

    emptyHint?.remove();

    await supabase.from("messages").insert({
      room_code: roomCode,
      content: text
    });

    msgInput.value = "";
  };

  /* ---------- RENDER MESSAGE ---------- */
  function renderMessage(m){
    emptyHint?.remove();
    const d = document.createElement("div");
    d.className = "msg other";
    d.textContent = m.content;
    messagesEl.appendChild(d);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  /* ---------- LOAD HISTORY ---------- */
  async function loadMessages(){
    const { data } = await supabase
      .from("messages")
      .select("*")
      .eq("room_code", roomCode)
      .order("created_at", { ascending: true });

    data?.forEach(renderMessage);
  }

  /* ---------- REALTIME ---------- */
  supabase
    .channel("room-"+roomCode)
    .on("postgres_changes", {
      event: "INSERT",
      schema: "public",
      table: "messages",
      filter: `room_code=eq.${roomCode}`
    }, payload => renderMessage(payload.new))
    .subscribe();

  /* ---------- EXIT (guaranteed animation) ---------- */
  exitBtn.onclick = async () => {
    if (exiting) return;
    exiting = true;

    closeMenu();
    exitOverlay.style.display = "flex";

    document.querySelectorAll(".msg").forEach((m,i)=>{
      setTimeout(()=>m.style.opacity="0", i*60);
    });

    setTimeout(() => location.href="/", 900);
  };

  /* ---------- TOAST ---------- */
  function toast(text){
    const t = document.createElement("div");
    t.textContent = text;
    t.style.cssText = `
      position:fixed;bottom:24px;left:50%;
      transform:translateX(-50%);
      background:#23233b;color:#fff;
      padding:10px 14px;border-radius:12px;
      font-size:13px;z-index:3000
    `;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),1800);
  }

  loadMessages();
});
</script>

</body>
</html>
