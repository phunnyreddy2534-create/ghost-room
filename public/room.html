<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IRA Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="style.css">

<!-- Supabase + Config -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
</head>

<body>

<!-- ================= HEADER ================= -->
<header class="room-header">
  <div class="header-left">
    <svg class="ira-logo" viewBox="0 0 100 100">
      <defs>
        <linearGradient id="iraGlow" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#6F7CFF"/>
          <stop offset="100%" stop-color="#8E97FF"/>
        </linearGradient>
      </defs>
      <circle
        cx="50"
        cy="50"
        r="42"
        fill="none"
        stroke="url(#iraGlow)"
        stroke-width="4"
        class="ira-ring"
        id="expiryRing"
      />
      <path
        d="M20 52 C30 46 40 46 50 52 C60 58 70 58 80 52"
        fill="none"
        stroke="url(#iraGlow)"
        stroke-width="3"
        stroke-linecap="round"
      />
    </svg>
    <span class="logo-text">IRA</span>
  </div>
  <button id="menuBtn" class="menu-btn">‚ò∞</button>
</header>

<!-- ================= MESSAGES ================= -->
<main class="messages" id="messages">
  <div class="system">You are anonymous here.</div>
  <div class="system" id="emptyHint">This room is quiet.</div>
</main>

<!-- ================= INPUT ================= -->
<footer class="input-bar" id="inputBar">
  <input
    id="msgInput"
    placeholder="Type without being known‚Ä¶"
    autocomplete="off"
  />
  <button id="sendBtn" class="primary-btn">Send</button>
</footer>

<!-- ================= MENU ================= -->
<div id="menuOverlay" class="menu-overlay">
  <div class="menu">
    <div class="menu-item" id="shareBtn">üîó Share quietly</div>
    <div class="menu-item danger" id="exitBtn">üóëÔ∏è Leave room</div>
  </div>
</div>

<!-- ================= LOGIC ================= -->
<script type="module">
  import { initMessages } from "./components/messages.js";

  document.addEventListener("DOMContentLoaded", async () => {

    /* ================= SESSION ID ================= */
    const SESSION_ID =
      sessionStorage.getItem("ira_session") ||
      (() => {
        const id = crypto.randomUUID();
        sessionStorage.setItem("ira_session", id);
        return id;
      })();

    /* ================= SUPABASE ================= */
    const supabase = window.supabase.createClient(
      IRA_CONFIG.SUPABASE_URL,
      IRA_CONFIG.SUPABASE_ANON_KEY
    );

    const roomCode = new URLSearchParams(location.search).get("room");
    const inputBar = document.getElementById("inputBar");

    if (!roomCode) {
      location.href = "/";
      return;
    }

    /* ================= ROOM VALIDATION ================= */
    const { data: room, error } = await supabase
      .from("rooms")
      .select("*")
      .eq("room_code", roomCode)
      .single();

    if (error || !room) {
      document.body.innerHTML = `
        <div style="
          height:100vh;
          display:flex;
          align-items:center;
          justify-content:center;
          background:#0A0B14;
          color:white;
          text-align:center">
          <div>
            <div style="opacity:.6">This room no longer exists.</div>
            <button class="primary-btn"
              style="margin-top:24px"
              onclick="location.href='/'">
              Go Home
            </button>
          </div>
        </div>
      `;
      return;
    }

    /* ================= EXPIRY ================= */
    const createdAt = new Date(room.created_at).getTime();
    const expiresAt = new Date(room.expires_at).getTime();
    const durationMs = expiresAt - createdAt;
    const ring = document.getElementById("expiryRing");

    let ended = false;

    async function endRoom() {
      if (ended) return;
      ended = true;

      inputBar.style.opacity = .3;
      inputBar.style.pointerEvents = "none";

      await supabase.from("messages").delete().eq("room_code", roomCode);
      await supabase.from("rooms").delete().eq("room_code", roomCode);

      const end = document.createElement("div");
      end.className = "room-ended";
      end.innerHTML = `
        <div style="opacity:.6">This room has faded.</div>
        <button class="primary-btn"
          style="margin-top:24px"
          onclick="location.href='/'">
          Leave quietly
        </button>
      `;
      document.body.appendChild(end);
    }

    setInterval(() => {
      const remaining = expiresAt - Date.now();
      const progress = Math.max(remaining / durationMs, 0);
      ring.style.opacity = Math.max(progress, 0.15);

      if (remaining <= 0) {
        endRoom();
      }
    }, 1000);

    /* ================= MENU ================= */
    const menuOverlay = document.getElementById("menuOverlay");

    document.getElementById("menuBtn").onclick = () => {
      menuOverlay.style.display = "block";
    };

    menuOverlay.onclick = e => {
      if (e.target === menuOverlay) {
        menuOverlay.style.display = "none";
      }
    };

    document.getElementById("exitBtn").onclick = () => {
      location.href = "/";
    };

    document.getElementById("shareBtn").onclick = async () => {
      try {
        if (navigator.share) {
          await navigator.share({ title: "IRA Room", url: location.href });
        } else {
          await navigator.clipboard.writeText(location.href);
          alert("Room link copied");
        }
      } catch {}
    };

    /* ================= INIT CHAT ================= */
    initMessages();
  });
</script>

</body>
</html>
