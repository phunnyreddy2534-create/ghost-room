<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Ghost Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===== EXPIRY BAR ===== */
.expiry-bar{
  padding:10px 14px;
  font-size:13px;
  opacity:.85;
}
.expiry-row{
  margin-bottom:6px;
}
.progress{
  height:6px;
  border-radius:6px;
  background:#1a1a28;
  overflow:hidden;
  margin-top:4px;
}
.progress > div{
  height:100%;
  background:linear-gradient(135deg,#6d5dfc,#9b8cff);
  width:100%;
  transition:width .5s linear;
}
</style>
</head>

<body>

<header class="room-header">
  <div class="logo">üëª Ghost Room</div>
  <div>
    <button id="exitBtn">Exit</button>
    <button id="shareBtn">Share</button>
  </div>
</header>

<!-- üî• EXPIRY STATUS -->
<div class="expiry-bar">
  <div class="expiry-row" id="roomExpiryText">‚è≥ Room expires in ‚Äî</div>
  <div class="progress"><div id="roomExpiryBar"></div></div>

  <div class="expiry-row" id="inactiveExpiryText">üí§ Inactive expires in ‚Äî</div>
  <div class="progress"><div id="inactiveExpiryBar"></div></div>
</div>

<div class="room-id" id="roomId"></div>
<div class="messages" id="messages"></div>

<div class="input-bar">
  <input id="msgInput" placeholder="Type a message..." autocomplete="off" />
  <button id="sendBtn">Send</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  /* ===== CONFIG ===== */
  const INACTIVITY_LIMIT_MS = 30 * 60 * 1000; // 30 minutes

  /* ===== SUPABASE ===== */
  const supabase = window.supabase.createClient(
    "https://ehvusinvfwsaxguuebfc.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVodnVzaW52ZndzYXhndXVlYmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNTcyMzYsImV4cCI6MjA4MjkzMzIzNn0.6W8OrbTz6RhN3P3R0KIN80Ec9GlkoMF4F0-Q4xRyy48"
  );

  const room = new URLSearchParams(location.search).get("room");
  if (!room) location.href = "/";

  const { data: roomData } = await supabase
    .from("rooms")
    .select("expires_at, expired")
    .eq("room_code", room)
    .single();

  if (!roomData || roomData.expired) expireRoom();

  const roomExpiresAt = roomData.expires_at
    ? new Date(roomData.expires_at).getTime()
    : null;

  const roomIdEl = document.getElementById("roomId");
  const messagesBox = document.getElementById("messages");
  const input = document.getElementById("msgInput");

  roomIdEl.textContent = "Room ID: " + room;

  let lastActivityTime = Date.now();

  /* ===== CLIENT ID ===== */
  let clientId = sessionStorage.getItem("ghost_client_id");
  if (!clientId) {
    clientId = crypto.randomUUID();
    sessionStorage.setItem("ghost_client_id", clientId);
  }

  /* ===== CACHE ===== */
  const cacheKey = `ghost_messages_${room}`;
  const getCachedMessages = () => JSON.parse(localStorage.getItem(cacheKey) || "[]");
  const saveCachedMessage = m => {
    const c = getCachedMessages();
    c.push(m);
    localStorage.setItem(cacheKey, JSON.stringify(c));
  };

  function addMessage(text, sender, time) {
    const div = document.createElement("div");
    div.className = "msg " + (sender === clientId ? "you" : "other");
    div.innerHTML = `<div>${text}</div><div class="time">${time}</div>`;
    messagesBox.appendChild(div);
    messagesBox.scrollTop = messagesBox.scrollHeight;
  }

  getCachedMessages().forEach(m => addMessage(m.text,m.sender,m.time));

  const { data: history } = await supabase
    .from("messages")
    .select("*")
    .eq("room_code", room)
    .order("created_at",{ascending:true});

  history?.forEach(m=>{
    addMessage(
      m.content,
      m.client_id,
      new Date(m.created_at).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"})
    );
    lastActivityTime = Date.now();
  });

  const roomChannel = supabase.channel(`room-${room}`);

  document.getElementById("sendBtn").onclick = async () => {
    const text = input.value.trim();
    if (!text) return;
    input.value = "";

    lastActivityTime = Date.now();

    const time = new Date().toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
    addMessage(text, clientId, time);
    saveCachedMessage({ text, sender: clientId, time });

    await supabase.from("messages").insert({
      room_code: room,
      client_id: clientId,
      content: text
    });
  };

  roomChannel.on("postgres_changes",
    {event:"INSERT",schema:"public",table:"messages",filter:`room_code=eq.${room}`},
    payload=>{
      if(payload.new.client_id===clientId) return;
      lastActivityTime = Date.now();
      const time = new Date(payload.new.created_at).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
      addMessage(payload.new.content,payload.new.client_id,time);
      saveCachedMessage({text:payload.new.content,sender:payload.new.client_id,time});
    }
  );

  await roomChannel.subscribe();

  /* ===== COUNTDOWN ENGINE ===== */
  setInterval(()=>{
    const now = Date.now();

    if(roomExpiresAt){
      const remaining = roomExpiresAt - now;
      if(remaining<=0) expireRoom();
      updateTimer(
        remaining,
        roomExpiresAt - (roomExpiresAt - remaining),
        "roomExpiryText",
        "roomExpiryBar",
        "‚è≥ Room expires in"
      );
    }

    const inactiveRemaining = INACTIVITY_LIMIT_MS - (now - lastActivityTime);
    if(inactiveRemaining<=0) expireRoom();

    updateTimer(
      inactiveRemaining,
      INACTIVITY_LIMIT_MS,
      "inactiveExpiryText",
      "inactiveExpiryBar",
      "üí§ Inactive expires in"
    );

  },1000);

  function updateTimer(ms,total,textId,barId,label){
    const m = Math.floor(ms/60000);
    const s = Math.floor((ms%60000)/1000);
    document.getElementById(textId).textContent =
      `${label}: ${m}m ${s}s`;
    document.getElementById(barId).style.width =
      Math.max(0,(ms/total)*100)+"%";
  }

  function expireRoom(){
    alert("üëª This room has faded away.");
    localStorage.removeItem(cacheKey);
    location.href="/";
  }

  document.getElementById("exitBtn").onclick = ()=>location.href="/";

  document.getElementById("shareBtn").onclick = async ()=>{
    navigator.share
      ? navigator.share({title:"Ghost Room",url:location.href})
      : navigator.clipboard.writeText(location.href);
  };

});
</script>

</body>
</html>
