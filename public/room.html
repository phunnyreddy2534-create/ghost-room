<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ghost Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="style.css" />

  <!-- Supabase v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>

<header class="room-header">
  <div class="logo">ðŸ‘» Ghost Room</div>
  <button id="shareBtn">Share</button>
</header>

<div class="room-id" id="roomId"></div>

<div class="messages" id="messages">
  <div class="system">You joined the room</div>
</div>

<div class="input-bar">
  <input id="msgInput" placeholder="Type a message..." autocomplete="off" />
  <button id="sendBtn">Send</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // ===== SUPABASE CONFIG =====
  const SUPABASE_URL = "https://ehvusinvfwsaxguuebfc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVodnVzaW52ZndzYXhndXVlYmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNTcyMzYsImV4cCI6MjA4MjkzMzIzNn0.6W8OrbTz6RhN3P3R0KIN80Ec9GlkoMF4F0-Q4xRyy48";

  const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  // ===== UNIQUE CLIENT ID (PER TAB / DEVICE) =====
  let clientId = localStorage.getItem("ghost_client_id");
  if (!clientId) {
    clientId = crypto.randomUUID();
    localStorage.setItem("ghost_client_id", clientId);
  }

  // ===== ROOM =====
  const params = new URLSearchParams(window.location.search);
  const room = params.get("room");

  if (!room) {
    alert("Room ID missing");
    location.href = "/";
    return;
  }

  // ===== ELEMENTS =====
  const roomLabel = document.getElementById("roomId");
  const messagesBox = document.getElementById("messages");
  const input = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  const shareBtn = document.getElementById("shareBtn");

  roomLabel.textContent = "Room ID: " + room;

  // ===== HELPER: ADD MESSAGE TO UI =====
  function addMessage(text, type) {
    const div = document.createElement("div");
    div.className = "msg " + (type === "you" ? "you" : "");
    div.textContent = text;
    messagesBox.appendChild(div);
    messagesBox.scrollTop = messagesBox.scrollHeight;
  }

  // ===== SEND MESSAGE =====
  sendBtn.onclick = async () => {
    const text = input.value.trim();
    if (!text) return;

    input.value = "";

    // Show immediately (optimistic UI)
    addMessage(text, "you");

    const { error } = await supabase.from("messages").insert({
      room_code: room,
      sender: "anon",
      client_id: clientId,
      content: text
    });

    if (error) {
      alert(error.message);
    }
  };

  // ===== RECEIVE MESSAGES (REALTIME) =====
  supabase
    .channel("room-" + room)
    .on(
      "postgres_changes",
      {
        event: "INSERT",
        schema: "public",
        table: "messages",
        filter: `room_code=eq.${room}`
      },
      payload => {
        // â— Ignore messages sent by THIS tab
        if (payload.new.client_id === clientId) return;

        addMessage(payload.new.content, "other");
      }
    )
    .subscribe();

  // ===== SHARE =====
  shareBtn.onclick = async () => {
    const url = location.href;
    if (navigator.share) {
      await navigator.share({ title: "Ghost Room", url });
    } else {
      await navigator.clipboard.writeText(url);
      alert("Room link copied");
    }
  };

});
</script>

</body>
</html>
