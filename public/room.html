<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IRA Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>

<style>
/* ===== Expiry Ring ===== */
.ira-ring {
  transition: opacity 2s linear;
}

.room-phase {
  position:fixed;
  top:64px;
  left:50%;
  transform:translateX(-50%);
  font-size:13px;
  color:rgba(255,255,255,.45);
  opacity:0;
  transition:opacity 1.2s ease;
  pointer-events:none;
}

.room-ended {
  position:fixed;
  inset:0;
  background:rgba(10,10,20,.92);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  color:white;
  z-index:3000;
  animation:fadeIn 1s ease forwards;
}

@keyframes fadeIn { from{opacity:0} to{opacity:1} }
</style>
</head>

<body>

<header class="room-header">
  <div class="header-left">
    <svg class="ira-logo" viewBox="0 0 100 100">
      <defs>
        <linearGradient id="iraGlow" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#6F7CFF"/>
          <stop offset="100%" stop-color="#8E97FF"/>
        </linearGradient>
      </defs>
      <circle cx="50" cy="50" r="42"
        fill="none"
        stroke="url(#iraGlow)"
        stroke-width="4"
        class="ira-ring"
        id="expiryRing"/>
      <path d="M20 52 C30 46 40 46 50 52 C60 58 70 58 80 52"
        fill="none"
        stroke="url(#iraGlow)"
        stroke-width="3"
        stroke-linecap="round"/>
    </svg>
    <span class="logo-text">IRA</span>
  </div>
  <button id="menuBtn" class="menu-btn">‚ò∞</button>
</header>

<div class="room-phase" id="roomPhase"></div>

<main class="messages" id="messages">
  <div class="system">You are anonymous here.</div>
  <div class="system" id="emptyHint">This room is quiet.</div>
</main>

<footer class="input-bar" id="inputBar">
  <input id="msgInput" placeholder="Type without being known‚Ä¶" autocomplete="off">
  <button id="sendBtn" class="primary-btn">Send</button>
</footer>

<!-- MENU -->
<div id="menuOverlay" class="menu-overlay">
  <div class="menu">
    <div class="menu-item" id="shareBtn">üîó Share quietly</div>
    <div class="menu-item danger" id="exitBtn">üóëÔ∏è Leave room</div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ===== BASIC STATE ===== */
  const roomCode = new URLSearchParams(location.search).get("room");
  const meta = JSON.parse(sessionStorage.getItem("ira_room_meta") || "{}");

  const createdAt = meta.created || Date.now();
  const durationMs = (meta.duration || 30) * 60 * 1000;
  const expiresAt = createdAt + durationMs;

  const ring = document.getElementById("expiryRing");
  const phaseText = document.getElementById("roomPhase");
  const inputBar = document.getElementById("inputBar");

  let ended = false;

  /* ===== SUPABASE ===== */
  const supabase = window.supabase.createClient(
    IRA_CONFIG.SUPABASE_URL,
    IRA_CONFIG.SUPABASE_ANON_KEY
  );

  const messagesEl = document.getElementById("messages");
  const emptyHint = document.getElementById("emptyHint");
  const msgInput = document.getElementById("msgInput");

  /* ===== MESSAGE SEND ===== */
  document.getElementById("sendBtn").onclick = async () => {
    if (ended) return;
    const t = msgInput.value.trim();
    if (!t) return;

    emptyHint?.remove();

    await supabase.from("messages").insert({
      room_code: roomCode,
      content: t
    });

    msgInput.value = "";
  };

  /* ===== RENDER ===== */
  function renderMessage(m){
    emptyHint?.remove();
    const d = document.createElement("div");
    d.className = "msg other";
    d.textContent = m.content;
    messagesEl.appendChild(d);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function loadMessages(){
    const { data } = await supabase
      .from("messages")
      .select("*")
      .eq("room_code", roomCode)
      .order("created_at",{ascending:true});
    data?.forEach(renderMessage);
  }

  supabase
    .channel("room-"+roomCode)
    .on("postgres_changes",{
      event:"INSERT",
      schema:"public",
      table:"messages",
      filter:`room_code=eq.${roomCode}`
    }, p => renderMessage(p.new))
    .subscribe();

  /* ===== EXPIRY ENGINE ===== */
  function updateExpiry(){
    if (ended) return;

    const now = Date.now();
    const remaining = expiresAt - now;
    const progress = Math.max(remaining / durationMs, 0);

    ring.style.opacity = Math.max(progress, 0.15);

    // PHASE MESSAGES
    if (progress < 0.5 && progress > 0.2) {
      showPhase("This room will fade soon.");
    } else if (progress <= 0.2 && progress > 0) {
      showPhase("A few moments remain.");
    }

    if (remaining <= 0) endRoom();
  }

  function showPhase(text){
    if (phaseText.textContent === text) return;
    phaseText.textContent = text;
    phaseText.style.opacity = 1;
    setTimeout(()=>phaseText.style.opacity = 0, 4000);
  }

  function endRoom(){
    ended = true;
    inputBar.style.opacity = .2;
    inputBar.style.pointerEvents = "none";

    const end = document.createElement("div");
    end.className = "room-ended";
    end.innerHTML = `
      <div style="opacity:.6">This room has ended.</div>
      <button class="primary-btn" style="margin-top:24px"
        onclick="location.href='/'">Leave quietly</button>
    `;
    document.body.appendChild(end);
  }

  setInterval(updateExpiry, 1000);

  /* ===== MENU ===== */
  const menuBtn = document.getElementById("menuBtn");
  const menuOverlay = document.getElementById("menuOverlay");

  menuBtn.onclick = ()=>menuOverlay.style.display="block";
  menuOverlay.onclick = e => {
    if (e.target === menuOverlay) menuOverlay.style.display="none";
  };

  document.getElementById("exitBtn").onclick = ()=>{
    location.href="/";
  };

  document.getElementById("shareBtn").onclick = async ()=>{
    try{
      if(navigator.share){
        await navigator.share({title:"IRA Room",url:location.href});
      } else {
        await navigator.clipboard.writeText(location.href);
      }
    }catch(e){}
  };

  loadMessages();
});
</script>

</body>
</html>
